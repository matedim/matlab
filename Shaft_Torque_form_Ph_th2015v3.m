clear all;
N_r=465;%         465/465/430/370/300
ngg_max=53500;%   54610/53500/53500/51370/50442
ngg_pr_max = 57000;% для Н и П одинаковые и для настройки 430
tg_max=660;% 681/660/660/636/625 для Н и П одинаковые и для настройки 430

%Создание массивов температур и давлений
th = -60:5:55; %С
Th = th+273.15; %К

Ph_mmM = 780:-10:400;%[760,674.1,596.2,525.8,462.2,405];       %780:-20:400; %мм рт.ст
Ph= Ph_mmM * 0.133322047232867; %кПа
%Задание зависимостей масивов nгг = f(Ne), tст = f(Ne)

ngg_f_N = [53.00046672,41992.80756;60.98040071,42380.12398;70.3186565,42826.37793;79.48716975,43255.78968;87.80684312,43626.2571;100.8807911,44173.52807;114.1247784,44678.6856;124.652122,45065.96807;139.25477,45562.68525;154.1971998,46034.1312;168.8001446,46471.89274;184.2523106,46892.79849;200.7233557,47330.53513;214.6473726,47692.50561;229.5902686,48071.30697;248.9482084,48542.69406;267.4570965,48997.248;283.5887836,49376.03352;298.7015917,49737.98815;315.6823306,50133.60682;330.7952235,50478.71698;343.3610033,50764.90545;363.0587249,51211.02131;384.7941199,51707.64341;399.7371854,52052.75583;419.6047343,52498.86943;436.4157307,52877.64589;454.9248306,53290.08865;469.0189291,53601.52346;480.3960874,53854.03883;494.3203162,54173.89813;504.3390255,54392.74268;516.0557536,54662.098;526.0742086,54931.47596;536.7719304,55209.2671;550.5259929,55596.50655;560.5444055,55874.30674;569.8836361,56126.84928;580.7506343,56514.12722;593.4,57000;600,57400;650,60820;700,66830];
%ngg_f_N = [21.84,35589;52.34,41922;166.61,46356;295.88,49619;332.54,50443;416.04,52306;483.3,53837;528.89,55031;583.5,56775];% Характеристика от 08.02.2012 АИ-450М №007
tg_f_N = [50.98032765,491.3126545;70.60955414,495.6769311;90.72756896,499.9662846;110.7892646,504.4991384;130.6065154,508.9196074;134.8933714,509.9123399;157.0609034,514.9696561;185.658786,521.7127444;200.5876781,525.4776354;220.4,530.07;237.4,534.52;244.9,536.55;251.8,538.23;259.4,540.09;268.9,542.62;277,544.81;286.7,547.51;294.5,549.53;302.4,551.89;310,554.08;318.3,556.61;325.9,559.14;334.6,561.67;344.2,565.04;356.4,569.25;366,572.79;377.9,577.34;386.7,580.55;397.4,584.76;408.2,589.48;419.7,594.2;426,596.9;434.2,600.61;444.6,605.66;454.2,610.38;462.7,614.77;471.5,619.49;479.6,623.87;487.2,628.08;498.6,634.83;506.8,639.72;514.5,643.76;521.2,648.31;525.8,651.35;531.1,654.72;537.7,659.1;541.9,661.97;550,668.3;600,706;700,798];
%tg_f_N = [21.84,535.58;52.34,509.22;166.61,510.65;295.88,533.83;332.54,544.8;416.04,573.58;483.3,603.76;528.89,629.36;583.5,668.48];%Характеристика от 08.02.2012 АИ-450М №007
%Gt_f_N = [168,71.6483844434205;170,72.2371824367406;172,72.5277099133142;174,72.8085851898960;176,73.1690240095753;178,73.5420040443061;180,73.8944543695865;182,74.2342474320269;184,74.5703586160069;186,74.9104689468406;188,75.2610563293558;190,75.6164792915870;192,75.9667077951771;194,76.3116418390017;196,76.6540594104733;198,76.9967504152060;200,77.3410330649485;202,77.6869778379449;204,78.0346081329095;206,78.3834463540524;208,78.7311368459569;210,79.0747871353781;212,79.4117607027948;214,79.7429654178549;216,80.0714057817231;218,80.4002183871938;220,80.7326483879943;222,81.0713525141159;224,81.4172306596841;226,81.7709019123584;228,82.1329914455321;230,82.5033011611463;232,82.8795313562171;234,83.2589699984252;236,83.6388017173583;238,84.0161112087910;240,84.3890970997188;242,84.7589283494219;244,85.1272756587256;246,85.4958625579179;248,85.8662035687592;250,86.2381547757287;252,86.6108807964840;254,86.9835127750836;256,87.3551500632693;258,87.7248715916739;260,88.0924005513588;262,88.4584980601960;264,88.8240366953153;266,89.1899131324988;268,89.5570463276931;270,89.9257656732486;272,90.2948944695598;274,90.6629888674031;276,91.0285597388630;278,91.3901659240728;280,91.7473759912497;282,92.1004113337335;284,92.4495100547382;286,92.7949243685444;288,93.1376594355920;290,93.4801255626532;292,93.8249471084477;294,94.1748180738894;296,94.5321012846762;298,94.8949888883412;300,95.2590769207276;302,95.6198149700717;304,95.9742206564213;306,96.3228074650475;308,96.6665574467220;310,97.0064792549890;312,97.3436081461656;314,97.6790059793417;316,98.0137597432193;318,98.3488397329808;320,98.6849769133662;322,99.0228906740136;324,99.3633161136034;326,99.7070040377953;328,100.054466792860;330,100.405264491604;332,100.758716015128;334,101.114120959154;336,101.470759634020;338,101.827893064687;340,102.184889210961;342,102.541939130479;344,102.899579923127;346,103.258360968258;348,103.618842958291;350,103.981597898712;352,104.347209108073;354,104.716271217995;356,105.089377449610;358,105.466500594303;360,105.846697739417;362,106.228931521489;364,106.612139642004;366,106.995234867391;368,107.377105029023;370,107.756617991219;372,108.133258997277;374,108.507777235152;376,108.881088405398;378,109.254127660691;380,109.627849605831;382,110.003228297743;384,110.381257245477;386,110.762949410207;388,111.149337205230;390,111.541283980452;392,111.937483044569;394,112.335189532041;396,112.731577704455;398,113.123763722120;400,113.508805644069;402,113.883741933902;404,114.248244050511;406,114.606398099279;408,114.962783269734;410,115.322069799137;412,115.689018972483;414,116.067656726742;416,116.457459377168;418,116.856281148748;420,117.261930067047;422,117.672169490494;424,118.084718110384;426,118.497249950877;428,118.907397889185;430,119.313742767068;432,119.717197870279;434,120.119036547860;436,120.520556004999;438,120.923077303023;440,121.327945359406;442,121.736520806123;444,122.149627661064;446,122.567188365191;448,122.989038232883;450,123.415008269657;452,123.844925172167;454,124.278609397441;456,124.715793872979;458,125.156092426209;460,125.599102997462;462,126.044415604798;464,126.491612344009;466,126.940267388615;468,127.389946989868;470,127.840209476750;472,128.290745240324;474,128.741977367445;476,129.194578372094;478,129.649231893089;480,130.106632557669;482,130.567485981497;484,131.032508768657;486,131.502419096548;488,131.977497423012;490,132.457390635256;492,132.941690265755;494,133.429980138723;496,133.921836370113;498,134.416827367619;500,134.914513830672;502,135.414448750445;504,135.916177409849;506,136.419237383535;508,136.923158537894;510,137.427463031056];
Gt_f_N = [21.84,39.1316;52.34,52.0286;166.61,70.6491;295.88,91.5032;332.54,98.0205;416.04,113.5793;483.3,126.7355;528.89,136.29;583.5,149.217];% Характеристика от 08.02.2012 АИ-450М №007
Pk_f_N = [21.84,2.9609;52.34,4.219;166.61,5.4761;295.88,6.5955;332.54,6.8996;416.04,7.5772;483.3,8.0666;528.89,8.3746;583.5,8.7521];  % Характеристика от 08.02.2012 АИ-450М №007
Gv_f_N = [21.84,0.8158;52.34,1.1078;166.61,1.3558;295.88,1.5573;332.54,1.6089;416.04,1.7198;483.3,1.7879;528.89,1.8233;583.5,1.8592]; % Характеристика от 08.02.2012 АИ-450М №007
%Pk_f_N = [20,3;480,8]; % Старая характеристика положенная в подсчеты Норм
%Pk_f_N =[53.38832487,4.204047218;61.18471517,4.301854975;75.4216018,4.480607083;93.04822335,4.691399663;110.5053582,4.885328836;135.92837,5.155143339;158.6395939,5.384485666;183.3846588,5.617200675;206.7738297,5.824620573;221.3496898,5.951096121;238.8068246,6.099494098;256.0944726,6.241146712;274.5685279,6.391231029;294.2289904,6.548060708;316.2622673,6.723440135;336.2617033,6.881956155;349.4816695,6.988195616;368.2946983,7.139966273;399.6497462,7.386172007;418.6322617,7.534569983;444.9027073,7.735244519;462.5293288,7.86846543;477.1051889,7.97470489;487.1049069,8.047217538;496.7656514,8.114671164;510.3245911,8.207419899;550,8.52;600,8.86];

%Создание кубической интерполяции nгг = f(Ne), Ne = f(nгг)
s_ngg_f_N = pchip(ngg_f_N(:,1),ngg_f_N(:,2));
s_N_f_ngg = pchip(ngg_f_N(:,2),ngg_f_N(:,1));

%Создание кубической интерполяции tст = f(Ne), Ne = f(tст)
s_tg_f_N = pchip(tg_f_N(:,1),tg_f_N(:,2));
s_N_f_tg = pchip(tg_f_N(:,2),tg_f_N(:,1));

%Создание кубической интерполяции Gт = f(Ne), Ne = f(Gт)
s_Gt_f_N = pchip(Gt_f_N(:,1),Gt_f_N(:,2));
s_N_f_Gt = pchip(Gt_f_N(:,2),Gt_f_N(:,1));

%Создание кубической интерполяции Pk = f(Ne), Ne = f(Gт)
s_Pk_f_N = pchip(Pk_f_N(:,1),Pk_f_N(:,2));
s_N_f_Pk = pchip(Pk_f_N(:,2),Pk_f_N(:,1));

%Создание кубической интерполяции Gв = f(Ne), Ne = f(Gв)
s_Gv_f_N = pchip(Gv_f_N(:,1),Gv_f_N(:,2));
s_N_f_Gv = pchip(Gv_f_N(:,2),Gv_f_N(:,1));

%Создание матриц
Rez=zeros(size(Ph_mmM,2)*size(Ph,2)*size(Th,2),15); % Rez=zeros(size(Ph,2)*size(Th,2),9);
ngg=zeros(size(Ph,2),size(Th,2)); ngg_pr=ngg;
tg=zeros(size(Ph,2),size(Th,2)); tg_pr=tg;
N=zeros(size(Ph,2),size(Th,2)); N_pr=N;
Gt=zeros(size(Ph,2),size(Th,2)); Gt_pr=Gt;
Pk=zeros(size(Ph,2),size(Th,2)); Pk_pr=Pk;
Gv=zeros(size(Ph,2),size(Th,2)); Gv_pr=Gv;

%Циклическое вычисление параметров двигателя при различных сочетаниях
%атмосферных условий (tн,Pн).
counter = 1;
for j=1:size(Ph,2)
 for i=1:size(Th,2)
  N_pr(j,i)=N_r*101.325/Ph(1,j)*sqrt(288.15/Th(1,i));
  ngg_pr(j,i)=ppval(s_ngg_f_N,N_pr(j,i));
  tg_pr(j,i)=ppval(s_tg_f_N,N_pr(j,i));
  ngg(j,i)=ngg_pr(j,i)*sqrt(Th(1,i)/288.15);
  tg(j,i)=(273.15+tg_pr(j,i))*Th(1,i)/288.15-273.15;
  if ngg(j,i)<ngg_max && tg(j,i)<tg_max && ngg_pr(j,i)<ngg_pr_max %Если в один из вычисленных параметров выходит за рамки ограничений
    N(j,i)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
  else
   % Vychislyaem moschnost' pri ogranichenii po maksimal'noi temperature
   tg_pr(j,i)=(tg_max+273.15)*(288.15/Th(1,i))-273.15;
   N_pr(j,i)=ppval(s_N_f_tg,tg_pr(j,i));
   N_ogr(1,1)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
   % Vychislyaem moschnost' pri ogranichenii po maksimal'noi chastote vrascheniya
   ngg_pr(j,i)=ngg_max*sqrt(288.15/Th(1,i));
   N_pr(j,i)=ppval(s_N_f_ngg,ngg_pr(j,i));
   N_ogr(1,2)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
   % Вычисляем мощность при ограничении по максимальной приведенной частоте вращения
   ngg_pr(j,i)=ngg_pr_max;
   N_pr(j,i)=ppval(s_N_f_ngg,ngg_pr(j,i));
   N_ogr(1,3)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
   
   [N_ogr_min,N_ogr_min_index] = min(N_ogr); %Определяем наименьшую мощностъ от каждого из ограничителей
   
   %Согласно наименьшей мощности из ограничений расчитываем остальные параметры
   if N_ogr_min_index==1 % tст_ф_max
    tg(j,i)=tg_max;
    tg_pr(j,i)=(tg(j,i)+273.15)*(288.15/Th(1,i))-273.15;
    N_pr(j,i)=ppval(s_N_f_tg,tg_pr(j,i));
    N(j,i)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
    ngg_pr(j,i)=ppval(s_ngg_f_N,N_pr(j,i));
    ngg(j,i)=ngg_pr(j,i)*sqrt(Th(1,i)/288.15);
   elseif  N_ogr_min_index==2 % nгг_ф_max
    ngg(j,i)=ngg_max;
    ngg_pr(j,i)=ngg(j,i)*sqrt(288.15/Th(1,i));
    N_pr(j,i)=ppval(s_N_f_ngg,ngg_pr(j,i));
    N(j,i)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
    tg_pr(j,i)=ppval(s_tg_f_N,N_pr(j,i));
    tg(j,i)=(273.15+tg_pr(j,i))*Th(1,i)/288.15-273.15;
   elseif N_ogr_min_index==3 % nгг_пр_max
    ngg_pr(j,i)=ngg_pr_max;
    ngg(j,i)=ngg_pr(j,i)*sqrt(Th(1,i)/288.15);
    N_pr(j,i)=ppval(s_N_f_ngg,ngg_pr(j,i));
    N(j,i)=N_pr(j,i)*Ph(1,j)/101.325*sqrt(Th(1,i)/288.15);
    tg_pr(j,i)=ppval(s_tg_f_N,N_pr(j,i));
    tg(j,i)=(273.15+tg_pr(j,i))*Th(1,i)/288.15-273.15;
   end % end if N_ogr_min
  end; % end if ngg
  
  % Fuell mass flow calculation
  Gt_pr(j,i)=ppval(s_Gt_f_N,N_pr(j,i));
  Gt(j,i)=decorrect_fuel_flow(Gt_pr(j,i),Th(1,i),Ph(1,j));
  % Calculation of pressure after the compressor
  Pk_pr(j,i)=ppval(s_Pk_f_N,N_pr(j,i));
  Pk(j,i)= decorrect_pressure(Pk_pr(j,i),Ph(1,j));
  
  % Air mass flow calculation
  Gv_pr(j,i)=ppval(s_Gv_f_N,N_pr(j,i));
  Gv(j,i)=decorrect_air_flow(Gv_pr(j,i),Th(1,i),Ph(1,j));
  
  %counter = (j-1)*size(Th,2)+i;
  Rez(counter,:)=[Ph_mmM(1,j),Ph(1,j),th(1,i),N_pr(j,i),N(j,i),ngg_pr(j,i),ngg(j,i),tg_pr(j,i),tg(j,i),Gt_pr(j,i),Gt(j,i),Pk_pr(j,i),Pk(j,i),Gv_pr(j,i),Gv(j,i)]; % Rez(counter,:)=[Ph(1,j),th(1,i),N_pr(j,i),N(j,i),ngg_pr(j,i),ngg(j,i),tg_pr(j,i),tg(j,i)];
  counter = counter+1;
 end; % end for i
end; % end for j
clearvars i j N_ogr_min_index N_ogr_min counter;
